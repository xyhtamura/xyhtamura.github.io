<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabota Language Visualizer</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/lucario.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/edit/matchbrackets.min.js"></script>

    <style>
        :root {
            --bg-color: #1e1e1e;
            --text-color: #d4d4d4;
            --primary-color: #007acc;
            --border-color: #333333;
            --section-bg: #252526;
            --grid-line-color: #404040;
            --point-color: #9cdcfe;
            --line-color: #4ec9b0;
            --group-color: #dcdcaa;
            /* Syntax Highlighting Colors */
            --json-key-color: #9cdcfe;
            --json-string-color: #ce9178;
            --json-number-color: #b5cea8;
            --json-boolean-color: #569cd6;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
        }
        h1, h2, h3, h4 {
            font-weight: 400;
            letter-spacing: 0.5px;
        }
        .main-container {
            width: 98%;
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        /* Layout Sections */
        .visualizer-row, .editor, .about {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--section-bg);
            padding: 20px;
        }
        .header-controls { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .zoom-controls { display: flex; gap: 10px; align-items: center; }
        .zoom-controls span { font-size: 14px; color: #aaa; }
        .zoom-btn, .action-btn { background-color: #3c3c3c; border: 1px solid var(--border-color); color: var(--text-color); padding: 5px 10px; font-size: 14px; cursor: pointer; border-radius: 4px; }

        #score-container {
            margin-top: 15px;
            overflow: auto;
            position: relative;
        }
        .timeline-wrapper {
            position: relative;
            display: grid;
            grid-template-columns: 70px 1fr;
            grid-template-rows: 1fr 40px;
            gap: 5px;
        }
        .timeline-view { grid-column: 2; grid-row: 1; position: relative; }
        .y-axis { grid-column: 1; grid-row: 1; position: relative; }
        .x-axis { grid-column: 2; grid-row: 2; position: relative; }
        .axis-label { position: absolute; font-size: 10px; color: #aaa; }
        .section-background { position: absolute; height: 100%; top: 0; opacity: 0.2; }
        .section-divider { position: absolute; width: 1px; height: 100%; top: 0; border-left: 1px dashed #cccccc80; }
        .section-divider-label { position: absolute; top: -18px; color: #ccc; font-size: 12px; background: #333; padding: 2px 5px; border-radius: 3px; transform: translateX(-50%); }

        .editor { display: flex; flex-direction: column; }
        .editor-header { display: flex; justify-content: space-between; align-items: center; }
        .editor-actions { display: flex; gap: 10px; }
        
        /* CodeMirror styles */
        .CodeMirror {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            height: 350px;
            font-size: 14px;
        }

        #render-btn { margin-top: 10px; padding: 10px 20px; background-color: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        .copy-btn { background: none; border: 1px solid var(--border-color); color: var(--text-color); padding: 5px 8px; cursor: pointer; border-radius: 4px; display: flex; align-items: center; gap: 5px; }
        .copy-btn:hover { background-color: #ffffff1a; }

        /* ABOUT SECTION STYLES */
        .about h2, .about h3, .about h4 { margin-top: 0; }
        .about p { line-height: 1.6; color: #ccc; }
        .about code { background-color: var(--bg-color); color: var(--json-string-color); padding: 2px 5px; border-radius: 3px; font-family: "Courier New", Courier, monospace; }
        .sample-container { margin-top: 20px; }
        .sample-container .editor-header { margin-bottom: 10px; }
        .sample-container pre { background-color: #1a1a1a; border: 1px solid var(--border-color); border-radius: 4px; padding: 15px; white-space: pre-wrap; word-wrap: break-word; font-size: 13px; max-height: 300px; overflow-y: auto; }
        .json-key { color: var(--json-key-color); }
        .json-string { color: var(--json-string-color); }
        .json-number { color: var(--json-number-color); }
        .json-boolean { color: var(--json-boolean-color); }

        /* Event & Grid Styles */
        .event-point, .event-group { position: absolute; width: 12px; height: 12px; border-radius: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 5px rgba(0,0,0,0.5); z-index: 10; }
        .event-point { background-color: var(--point-color); }
        .event-group { background-color: var(--group-color); border: 2px solid var(--json-string-color); }
        .event-line { position: absolute; height: 2px; background-color: var(--line-color); transform-origin: 0 50%; z-index: 9; }
        .event-payload { position: absolute; transform: translate(15px, -50%); font-size: 12px; color: var(--json-string-color); white-space: nowrap; z-index: 11; }
        .grid-line-vertical { position: absolute; width: 1px; height: 100%; top: 0; background-color: var(--grid-line-color); }
        
    </style>
</head>
<body>
    <div class="main-container">
        <h1>Tabota (Taboç”°)</h1>
        
        <div class="visualizer-row">
            <div class="header-controls">
                <h2>Graphical Output</h2>
                <div class="zoom-controls">
                    <span>X-Axis Zoom:</span>
                    <button class="zoom-btn" id="zoom-x-out">-</button>
                    <button class="zoom-btn" id="zoom-x-in">+</button>
                </div>
                 <div class="zoom-controls">
                    <span>Y-Axis Zoom:</span>
                    <button class="zoom-btn" id="zoom-y-out">-</button>
                    <button class="zoom-btn" id="zoom-y-in">+</button>
                </div>
            </div>
            <div id="score-container"></div>
        </div>
        
        <div class="editor">
            <div class="editor-header">
                <h2>JSON Input</h2>
                <div class="editor-actions">
                    <button class="action-btn" id="beautify-btn">Beautify</button>
                    <button class="copy-btn" id="copy-main-json">
                         <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                        Copy
                    </button>
                </div>
            </div>
            <textarea id="json-input"></textarea>
            <button id="render-btn">Render Score</button>
        </div>
        
         <h3>How It Works: The Core Concepts</h3>
    <p>
        A Tabota score is structured as a series of <strong>Sections</strong>. Each section has its own rules for how time (the X-axis) and values (the Y-axis) are interpreted.
    </p>
    <ul>
        <li>
            <strong>Temporal Regimes (The X-Axis)</strong>: This defines the "flow of time."
            <ul>
                <li><code>"metered"</code>: Traditional musical time with a BPM and beat grid.</li>
                <li><code>"chronological"</code>: Absolute time measured in seconds.</li>
                <li><code>"achronous"</code>: A sequence of events defined only by their order, not a specific time value.</li>
            </ul>
        </li>
        <li>
            <strong>Axis Modes (The Y-Axis)</strong>: This defines what the vertical values mean.
            <ul>
                <li><code>"frequency"</code>: For music. The Y-axis represents pitch in Hertz (Hz).</li>
                <li><code>"categorical"</code>: For percussion or named triggers. The Y-axis is divided into lanes for each category (e.g., "Kick", "Snare").</li>
                <li><code>"instructional"</code>: For performance art or abstract cues. The Y-axis is just for visual organization, and the core data is text inside an event's <code>payload</code>.</li>
            </ul>
        </li>
        <li>
            <strong>Events (The Primitives)</strong>: These are the actual building blocks of the score.
            <ul>
                <li><code>"point"</code>: An instantaneous event, like a drum hit or a single cue.</li>
                <li><code>"line"</code>: An event with a duration, like a melodic glide or a sustained action.</li>
                <li><code>"group"</code>: A container for events that should happen simultaneously in the <code>achronous</code> regime.</li>
            </ul>
        </li>
    </ul>
            <h3>Try Other Samples</h3>
            <div class="sample-container"><div class="editor-header"><h4>Sample 1: Microtonal Scale</h4><button class="copy-btn" data-target="sample1">Copy & Render</button></div><pre><code id="sample1"></code></pre></div>
            <div class="sample-container"><div class="editor-header"><h4>Sample 2: Theatrical Cue Sequence</h4><button class="copy-btn" data-target="sample2">Copy & Render</button></div><pre><code id="sample2"></code></pre></div>
        </div>
    </div>
    <script>
        // --- STATE & CONFIG ---
        let zoom = { x: 1, y: 1 };
        const BASE_TIMELINE_HEIGHT = 300; // px
        let codeEditor;

        const samples = {
            main: `{ "projectName": "Tabota Language Showcase", "score": [ { "sectionId": "A1_Melody", "temporalRegime": "metered", "regimeSettings": { "beats": 4 }, "axisMode": "frequency", "modeSettings": { "minHz": 100, "maxHz": 2000 }, "events": [ { "type": "line", "startTime": 0, "endTime": 2, "startYValue": 440.0, "endYValue": 523.25, "payload": { "comment": "A4 to C5" } }, { "type": "point", "time": 2.5, "yValue": 587.33, "payload": { "comment": "D5" } }, { "type": "line", "startTime": 3, "endTime": 4, "startYValue": 659.25, "endYValue": 675.50, "payload": { "comment": "E5 bend" } } ] }, { "sectionId": "B1_Rhythm", "temporalRegime": "chronological", "regimeSettings": { "duration": 2 }, "axisMode": "categorical", "modeSettings": { "categories": ["Kick", "Snare", "Hi-Hat"] }, "events": [ { "type": "point", "time": 0.0, "yValue": "Kick" }, { "type": "point", "time": 0.5, "yValue": "Snare" }, { "type": "point", "time": 1.0, "yValue": "Kick" }, { "type": "point", "time": 1.5, "yValue": "Snare" } ] }, { "sectionId": "C1_Performance", "temporalRegime": "achronous", "regimeSettings": { "indices": 4 }, "axisMode": "instructional", "events": [ { "type": "point", "index": 0, "yValue": 20, "payload": { "text": "Lights fade up" } }, { "type": "line", "startIndex": 1, "endIndex": 3, "startYValue": 50, "endYValue": 50, "payload": { "text": "Hold drone sound" } } ] } ] }`,
            sample1: `{ "projectName": "Microtonal Scale", "score": [ { "sectionId": "Scale", "temporalRegime": "metered", "regimeSettings": { "beats": 8 }, "axisMode": "frequency", "modeSettings": { "minHz": 200, "maxHz": 600 }, "events": [ { "type": "point", "time": 0, "yValue": 261.63 }, { "type": "point", "time": 1, "yValue": 293.66 }, { "type": "point", "time": 2, "yValue": 329.63 }, { "type": "point", "time": 3, "yValue": 349.23 }, { "type": "point", "time": 4, "yValue": 392.00 }, { "type": "point", "time": 5, "yValue": 440.00 }, { "type": "point", "time": 6, "yValue": 493.88 }, { "type": "point", "time": 7, "yValue": 530.15 } ] } ] }`,
            sample2: `{ "projectName": "Simple Stage Play", "score": [ { "sectionId": "Act 1, Scene 1", "temporalRegime": "achronous", "regimeSettings": { "indices": 4 }, "axisMode": "instructional", "events": [ { "type": "point", "index": 0, "yValue": 25, "payload": { "text": "House lights down." } }, { "type": "point", "index": 1, "yValue": 50, "payload": { "text": "Spotlight on center stage." } }, { "type": "line", "startIndex": 2, "endIndex": 3, "startYValue": 75, "endYValue": 75, "payload": { "text": "Actor walks (1 index duration)." } }, { "type": "point", "index": 4, "yValue": 75, "payload": { "text": "Actor speaks: 'Am I late?'" } } ] } ] }`
        };
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            codeEditor = CodeMirror.fromTextArea(document.getElementById('json-input'), {
                mode: { name: "javascript", json: true },
                theme: "lucario",
                lineNumbers: true,
                matchBrackets: true
            });
            codeEditor.setValue(JSON.stringify(JSON.parse(samples.main), null, 2));

            document.getElementById('sample1').innerHTML = syntaxHighlight(samples.sample1);
            document.getElementById('sample2').innerHTML = syntaxHighlight(samples.sample2);
            
            // Event Listeners
            document.querySelectorAll('.copy-btn').forEach(btn => btn.addEventListener('click', handleCopyClick));
            document.getElementById('render-btn').addEventListener('click', renderScore);
            document.getElementById('beautify-btn').addEventListener('click', beautifyJson);
            document.getElementById('zoom-x-in').addEventListener('click', () => { zoom.x *= 1.25; renderScore(); });
            document.getElementById('zoom-x-out').addEventListener('click', () => { zoom.x = Math.max(0.25, zoom.x / 1.25); renderScore(); });
            document.getElementById('zoom-y-in').addEventListener('click', () => { zoom.y *= 1.25; renderScore(); });
            document.getElementById('zoom-y-out').addEventListener('click', () => { zoom.y = Math.max(0.25, zoom.y / 1.25); renderScore(); });

            renderScore();
        });

        // --- DATA PROCESSING ---
        function processScore(scoreData) {
            let globalTime = 0;
            const processedSections = [];
            const processedEvents = [];
            let totalDuration = 0;

            (scoreData.score || []).forEach(section => {
                const duration = section.regimeSettings.beats || section.regimeSettings.duration || section.regimeSettings.indices || 1;
                const sectionStartTime = globalTime;
                
                processedSections.push({ ...section, startTime: sectionStartTime, duration });

                (section.events || []).forEach(event => {
                    const localStartTime = event.time ?? event.startTime ?? event.startIndex ?? 0;
                    const localEndTime = event.endTime ?? event.endIndex ?? localStartTime;
                    processedEvents.push({
                        ...event,
                        section,
                        globalStartTime: sectionStartTime + localStartTime,
                        globalEndTime: sectionStartTime + localEndTime
                    });
                });
                globalTime += duration;
            });
            totalDuration = globalTime;
            return { processedSections, processedEvents, totalDuration };
        }

        // --- RENDER LOGIC ---
        function renderScore() {
            const scoreContainer = document.getElementById('score-container');
            scoreContainer.innerHTML = '';
            let scoreData;
            try {
                scoreData = JSON.parse(codeEditor.getValue());
            } catch (e) {
                scoreContainer.innerHTML = `<p style="color: #ff8888;">Error parsing JSON: ${e.message}</p>`;
                return;
            }

            const { processedSections, processedEvents, totalDuration } = processScore(scoreData);
            if (totalDuration === 0) return;

            const wrapper = document.createElement('div');
            wrapper.className = 'timeline-wrapper';
            const timelineHeight = BASE_TIMELINE_HEIGHT * zoom.y;
            wrapper.style.height = `${timelineHeight}px`;
            
            const timelineView = document.createElement('div');
            timelineView.className = 'timeline-view';
            timelineView.style.width = `${100 * zoom.x}%`;

            const yAxis = document.createElement('div'); yAxis.className = 'y-axis';
            const xAxis = document.createElement('div'); xAxis.className = 'x-axis';
            xAxis.style.width = `${100 * zoom.x}%`;
            
            wrapper.append(yAxis, timelineView, xAxis);
            
            drawBackground(processedSections, timelineView, xAxis, yAxis, totalDuration);
            drawEvents(processedEvents, timelineView, totalDuration, timelineHeight); // Pass height for line calc
            scoreContainer.appendChild(wrapper);
        }

        function drawBackground(sections, view, xAxis, yAxis, totalDuration) {
            const colors = ['#007acc30', '#4ec9b030', '#dcdcaa30'];
            sections.forEach((section, i) => {
                const xStart = (section.startTime / totalDuration) * 100;
                const width = (section.duration / totalDuration) * 100;
                const bg = document.createElement('div'); bg.className = 'section-background'; bg.style.left = `${xStart}%`; bg.style.width = `${width}%`; bg.style.backgroundColor = colors[i % colors.length]; view.appendChild(bg);
                const divider = document.createElement('div'); divider.className = 'section-divider'; divider.style.left = `${xStart}%`; const label = document.createElement('div'); label.className = 'section-divider-label'; label.textContent = section.sectionId; divider.appendChild(label); view.appendChild(divider);
            });

            for (let i = 0; i <= totalDuration * zoom.x; i++) { // Add more lines when zoomed
                const xPos = (i / totalDuration) * 100;
                if (xPos > 100) break;
                const line = document.createElement('div'); line.className = 'grid-line-vertical'; line.style.left = `${xPos}%`; view.appendChild(line);
                const label = document.createElement('div'); label.className = 'axis-label'; label.textContent = i; label.style.left = `${xPos}%`; label.style.transform = 'translateX(-50%)'; xAxis.appendChild(label);
            }

            if (sections.length > 0) {
                 const firstSection = sections[0];
                 if (firstSection.axisMode === 'frequency') { const {minHz = 20, maxHz = 20000} = firstSection.modeSettings; for (let i = 0; i < 10; i++) { const p = i / 9; const hz = Math.exp(Math.log(minHz) + p * (Math.log(maxHz) - Math.log(minHz))); const yPos = (1 - p) * 100; const label = document.createElement('div'); label.className = 'axis-label'; label.textContent = `${hz < 1000 ? Math.round(hz) : (hz/1000).toFixed(1)+'k'} Hz`; label.style.top = `${yPos}%`; label.style.right = '5px'; label.style.transform = 'translateY(-50%)'; yAxis.appendChild(label); } }
                 else if (firstSection.axisMode === 'categorical') { firstSection.modeSettings.categories.forEach((cat, i) => { const yPos = (i + 0.5) / firstSection.modeSettings.categories.length * 100; const label = document.createElement('div'); label.className = 'axis-label'; label.textContent = cat; label.style.top = `${yPos}%`; label.style.right = '5px'; label.style.transform = 'translateY(-50%)'; yAxis.appendChild(label); }); }
            }
        }
        
        function drawEvents(events, container, totalDuration, timelineHeight) {
            // FIX: Use known dimensions for line calculation instead of measuring the DOM element.
            const timelineViewportWidth = document.getElementById('score-container').clientWidth;
            const fullTimelineWidth = timelineViewportWidth * zoom.x;

            function getXPos(timeValue) { return (timeValue / totalDuration) * 100; }
            function getYPos(yValue, section) {
                 if (section.axisMode === 'frequency') { const {minHz = 20, maxHz = 20000} = section.modeSettings; const logMin = Math.log(minHz); const logMax = Math.log(maxHz); if (yValue <= 0) return 100; const logY = Math.log(yValue); return (1 - (logY - logMin) / (logMax - logMin)) * 100; }
                if (section.axisMode === 'categorical') { const index = section.modeSettings.categories.indexOf(yValue); return (index + 0.5) / section.modeSettings.categories.length * 100; }
                return yValue || 50;
            }
            events.forEach(event => {
                if (event.type === 'point') { const el = document.createElement('div'); el.className = 'event-point'; el.style.left = `${getXPos(event.globalStartTime)}%`; el.style.top = `${getYPos(event.yValue, event.section)}%`; container.appendChild(el); if(event.payload?.text) addPayload(el, event.payload.text); if(event.payload?.comment) el.title = event.payload.comment; }
                else if (event.type === 'line') {
                    const startX = getXPos(event.globalStartTime); const startY = getYPos(event.startYValue, event.section); const endX = getXPos(event.globalEndTime); const endY = getYPos(event.endYValue, event.section);
                    const el = document.createElement('div'); el.className = 'event-line';
                    const dx = (endX - startX) / 100 * fullTimelineWidth;
                    const dy = (endY - startY) / 100 * timelineHeight;
                    const length = Math.sqrt(dx * dx + dy * dy);
                    const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                    el.style.left = `${startX}%`; el.style.top = `${startY}%`; el.style.width = `${length}px`; el.style.transform = `rotate(${angle}deg)`;
                    container.appendChild(el); if(event.payload?.text) addPayload(el, event.payload.text); if(event.payload?.comment) el.title = event.payload.comment;
                }
                else if (event.type === 'group') { const el = document.createElement('div'); el.className = 'event-group'; el.style.left = `${getXPos(event.globalStartTime)}%`; el.style.top = `${getYPos(event.yValue, event.section)}%`; container.appendChild(el); if(event.payload?.comment) el.title = event.payload.comment; (event.events || []).forEach(subEvent => { const point = document.createElement('div'); point.className = 'event-point'; point.style.left = `50%`; point.style.top = `${50 + (subEvent.yValue || 0)}%`; el.appendChild(point); if(subEvent.payload?.text) addPayload(point, subEvent.payload.text, true); }); }
            });
        }
        function addPayload(element, text, isSubEvent = false) { const payloadEl = document.createElement('div'); payloadEl.className = 'event-payload'; payloadEl.textContent = text; if(isSubEvent) payloadEl.style.transform = 'translate(15px, 0px)'; element.appendChild(payloadEl); }

        // --- UTILITIES ---
        function beautifyJson() { try { const ugly = codeEditor.getValue(); const obj = JSON.parse(ugly); const pretty = JSON.stringify(obj, undefined, 2); codeEditor.setValue(pretty); } catch (e) { console.error("Could not beautify invalid JSON."); } }
        function handleCopyClick(e) { const targetId = e.currentTarget.dataset.target; const textToCopy = targetId ? samples[targetId] : codeEditor.getValue(); navigator.clipboard.writeText(textToCopy).then(() => { const originalText = e.currentTarget.innerHTML; e.currentTarget.innerHTML = 'Copied!'; if (targetId) { codeEditor.setValue(JSON.stringify(JSON.parse(textToCopy), null, 2)); renderScore(); } setTimeout(() => { e.currentTarget.innerHTML = originalText; }, 1500); }).catch(err => console.error('Failed to copy: ', err)); }
        function syntaxHighlight(jsonString) { if (typeof jsonString != 'string') { jsonString = JSON.stringify(jsonString, undefined, 2); } jsonString = jsonString.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); return jsonString.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) { let cls = 'json-number'; if (/^"/.test(match)) { cls = /:$/.test(match) ? 'json-key' : 'json-string'; } else if (/true|false/.test(match)) { cls = 'json-boolean'; } return '<span class="' + cls + '">' + match + '</span>'; }); }
    </script>
</body>
</html>